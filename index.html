<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>  

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.sound.min.js"></script>

    <style type="text/css">
      *{
        padding: 0;
        margin: 0;
        background: black;
      }
      canvas{
        display:block;
      }
    </style>
  </head>
  <body>
    <!-- p5js -->
    <script>
      const areaDic = {
        // top upperLeft, second upperRight, dl downerLeft, bottom downerRight
        top : {x : 0, y : 0, w : 0, h : 0},
        second : {x : 0, y : 0, w : 0, h : 0},
        third : {x : 0, y : 0, w : 0, h : 0},
        bottom : {x : 0, y : 0, w : 0, h : 0}
      }
      //状態管理用の配列、送られてきた状態がここに入る
      let stateArray = [0,0,0,0];
      let pastStateArray = [0,0,0,0];
      let modeState = 0;

      // aはqでオン、aでオフ・bはwでオン、sでオフ
      let controlDic = {a : 0, b : 0, c : 0, d : 0, e : 0, f : 0, g : 0}

      let loopCheckDic = {a : 0, b : 0, c : 0, d : 0, e : 0, f : 0, g : 0}
      let polySynthA = new p5.PolySynth();
      let polySynthC = new p5.PolySynth();
      let polySynthD = new p5.PolySynth();
      let polySynthE = new p5.PolySynth();
      let polySynthF = new p5.PolySynth();
      let polySynthG = new p5.PolySynth();


      let touchState = 0;

      function setup(){
        createCanvas(windowWidth, windowHeight);

        areaDic.top.x = 0;
        areaDic.top.y = 0;
        areaDic.top.w = width;
        areaDic.top.h = height/4;

        areaDic.second.x =  0;
        areaDic.second.y = height/4;
        areaDic.second.w = width;
        areaDic.second.h = height/2;

        areaDic.third.x = 0;
        areaDic.third.y = height/2;
        areaDic.third.w = width;
        areaDic.third.h = height*3/4;

        areaDic.bottom.x = 0;
        areaDic.bottom.y = height*3/4;
        areaDic.bottom.w = width;
        areaDic.bottom.h = height;
      }


      function draw(){
        colorMode(RGB, 256);
        if(modeState === 0){
          background(255);
          stroke(0);
          strokeWeight(3);
          if(touchState === 1){
            fill(180);
          }else{
            fill(255);
          }
          rect(areaDic.top.x, areaDic.top.y, areaDic.top.w, areaDic.top.h);

          if(touchState === 2){
            fill(180);
          }else{
            fill(255);
          }
          rect(areaDic.second.x, areaDic.second.y, areaDic.second.w, areaDic.second.h);

          if(touchState === 3){
            fill(180);
          }else{
            fill(255);
          }
          rect(areaDic.third.x, areaDic.third.y, areaDic.third.w, areaDic.third.h);

          if(touchState === 4){
            fill(180);
          }else{
            fill(255);
          }
          rect(areaDic.bottom.x, areaDic.bottom.y, areaDic.bottom.w, areaDic.bottom.h);

        }else if(modeState === 1){
          noStroke();
          background(0);
          if(controlDic.a === 1){
            if(stateArray[0]-pastStateArray[0] >= 1){
              playSynth();
              fill(255);
            }else{
              fill(0);
            }
            rect(0, 0, width, height/4);

            if(stateArray[1]-pastStateArray[1] >= 1){
              playSynth();
              fill(255);
            }else{
              fill(0);
            }
            rect(0, height/4, width, height/4);

            if(stateArray[2]-pastStateArray[2] >= 1){
              playSynth();
              fill(255);
            }else{
              fill(0);
            }
            rect(0, height/2, width, height/4);

            if(stateArray[3]-pastStateArray[3] >= 1){
              playSynth();
              fill(255);
            }else{
              fill(0);
            }
            rect(0, height*3/4, width, height/4);
          }

          if(controlDic.b === 1){
            colorMode(HSB, 120);
            let rectX = frameCount * 15 % width * 2;
            if(rectX < loopCheckDic.b){
              playSynthB(width * 2 / 15 / 60);
            }
            loopCheckDic.b = rectX;

            fill(stateArray[0] * 6 % 100, 0, 120);
            rect(rectX - stateArray[0] * width / 10 % width, 0, stateArray[0] * width / 10 % width, height/4);
            fill(stateArray[1] * 6 % 100, 0, 120);
            rect(rectX - stateArray[1] * width / 10 % width, height/4, stateArray[1] * width / 10 % width, height/4);
            fill(stateArray[2] * 6 % 100, 0, 120);
            rect(rectX - stateArray[2] * width / 10 % width, height/2, stateArray[2] * width / 10 % width, height/4);
            fill(stateArray[3] * 6 % 100, 0, 120);
            rect(rectX - stateArray[3] * width / 10 % width, height*3/4, stateArray[3] * width / 10 % width, height/4);
          }

          if(controlDic.c === 1){
            colorMode(HSB, 120);
            let rectX = frameCount * 10 % width;
            if(rectX < loopCheckDic.c){
              let temp = width / 10 / 60;
              playSynthC(temp);
            }

            loopCheckDic.c = rectX;

            function cDisplay(b) {
              fill(stateArray[0] * 6 % 100, 0, b);
              rect(rectX -  stateArray[0] * width / 10 % width / 15, 0, stateArray[0] * width / 10 % width / 15, height/4);
              fill(stateArray[1] * 6 % 100, 0, b);
              rect(rectX - stateArray[1] * width / 10 % width / 15, height/4, stateArray[1] * width / 10 % width / 15, height/4);
              fill(stateArray[2] * 6 % 100, 0, b);
              rect(rectX - stateArray[2] * width / 10 % width / 15, height/2, stateArray[2] * width / 10 % width / 15, height/4);
              fill(stateArray[3] * 6 % 100, 0, b);
              rect(rectX - stateArray[3] * width / 10 % width / 15, height*3/4, stateArray[3] * width / 10 % width / 15, height/4);
            }
            rectX = width - (frameCount + width / 5) * 10 % width;
            cDisplay(80);
            rectX = width - (frameCount + width / 5) * 2 * 10 % width;
            cDisplay(60);
            rectX = width - (frameCount + width / 5) * 3 * 10 % width;
            cDisplay(40);
            rectX = width - (frameCount + width / 5) * 4 * 10 % width;
            cDisplay(20);
            rectX = width - (frameCount + width / 5) * 5 * 10 % width;
            cDisplay(0);
          }

          if(controlDic.d === 1){
            colorMode(HSB, 120);
            let rectX = (frameCount + width / 4) * 10 % width;

            if(rectX < loopCheckDic.d){
              let temp = width / 10 / 60;
              playSynthD(temp);
            }

            loopCheckDic.d = rectX;

            function cDisplay(b) {
              fill(stateArray[0] * 6 % 100, 17, b);
              rect(rectX, 0, stateArray[0] * width / 10 % width / 15, height/4);
              fill(stateArray[1] * 6 % 100, 17, b);
              rect(rectX , height/4, stateArray[1] * width / 10 % width / 15, height/4);
              fill(stateArray[2] * 6 % 100, 17, b);
              rect(rectX , height/2, stateArray[2] * width / 10 % width / 15, height/4);
              fill(stateArray[3] * 6 % 100, 17, b);
              rect(rectX, height*3/4, stateArray[3] * width / 10 % width / 15, height/4);
            }
            rectX = (frameCount + width / 4) * 10 % width;
            cDisplay(40);
            rectX = (frameCount + width / 3) * 2 * 10 % width;
            cDisplay(30);
            rectX = (frameCount + width / 6) * 3 * 10 % width;
            cDisplay(20);
            rectX = (frameCount + width / 3) * 4 * 10 % width;
            cDisplay(10);
            rectX = (frameCount + width / 4) * 5 * 10 % width;
            cDisplay(0);
          }

          if(controlDic.e === 1){
            let rectY = height - frameCount * 50 % height * 2;
            if(rectY < loopCheckDic.e){
              playSynthE(width * 2 / 50 / 60);
            }
            loopCheckDic.e = rectY;

          }
          
          if(controlDic.f === 1){
            let rectY = height - frameCount * 40 % height * 2;

            if(rectY < loopCheckDic.f){
              playSynthF(width * 2 / 40 / 60);
            }
            loopCheckDic.f = rectY;

            fill(0, 63);
            rect(0, rectY, width, height / 3);
          }

          if(controlDic.g === 1){
            colorMode(HSB, 120);
            let rectX = frameCount * 5 % width * 2;

            if(rectX < loopCheckDic.g){
              playSynthG(width * 2 / 5 / 60);
            }

            loopCheckDic.g = rectX;

            fill(stateArray[0] * 6 % 100, 0, 0);
            rect(rectX - stateArray[0] * width / 10 % width / 2, 0, stateArray[0] * width / 10 % width / 2, height/4);
            fill(stateArray[1] * 6 % 100, 0, 0);
            rect(rectX - stateArray[1] * width / 10 % width / 2, height/4, stateArray[1] * width / 10 % width / 2, height/4);
            fill(stateArray[2] * 6 % 100, 0, 0);
            rect(rectX - stateArray[2] * width / 10 % width / 2, height/2, stateArray[2] * width / 10 % width / 2, height/4);
            fill(stateArray[3] * 6 % 100, 0, 0);
            rect(rectX - stateArray[3] * width / 10 % width / 2, height*3/4, stateArray[3] * width / 10 % width / 2, height/4);
          }

          stroke(0);
          strokeWeight(height/100 * 2);
          line(0,0,width,0);

          strokeWeight(height/100);
          line(0,height/4,width,height/4);
          line(0,height/2,width,height/2);
          line(0,height*3/4,width,height*3/4);

          strokeWeight(height/100 * 2);
          line(0,height,width,height);
        }
        
        if(controlDic.e === 1){
          noStroke();
          fill(0);
          let rectY = height - frameCount * 50 % height * 2;

          rect(0, rectY, stateArray[0] * width / 10 % width / 4, 3);

          rect(width / 4, rectY, stateArray[1] * width / 10 % width / 4, 3);

          rect(width / 2, rectY, stateArray[2] * width / 10 % width / 4, 3);

          rect(width * 3 /4 , rectY, stateArray[3] * width / 10 % width / 4, 3);
        }

        pastStateArray = stateArray;
      }
      function keyPressed(){
        if(key === "p"){
          polySynth = new p5.PolySynth();
          modeState = 1;
        }else if(key === "0"){
          modeState = 0;
        }

        //controlDicについて
        if(key === "q"){
          controlDic.a = 1;
        }else if(key === "a"){
          controlDic.a = 0;
        }
        if(key === "w"){
          controlDic.b = 1;
        }else if(key === "s"){
          controlDic.b = 0;
        }
        if(key === "e"){
          controlDic.c = 1;
        }else if(key === "d"){
          controlDic.c = 0;
        }
        if(key === "r"){
          controlDic.d = 1;
        }else if(key === "f"){
          controlDic.d = 0;
        }
        if(key === "t"){
          controlDic.e = 1;
        }else if(key === "g"){
          controlDic.e = 0;
        }
        if(key === "y"){
          controlDic.f = 1;
        }else if(key === "h"){
          controlDic.f = 0;
        }
        if(key === "u"){
          controlDic.g = 1;
        }else if(key === "j"){
          controlDic.g = 0;
        }
      }
      //これでクリックとタッチ両方に対応できている。
      function touchStarted(){
        if (areaDic.top.x <= winMouseX && winMouseX <= areaDic.top.w
        && areaDic.top.y <= winMouseY && winMouseY < areaDic.top.h){
          touchState = 1;
          sendTop();
        }
        else if (areaDic.second.x <= winMouseX && winMouseX <= areaDic.second.w
        && areaDic.second.y <= winMouseY && winMouseY < areaDic.second.h){
          touchState = 2;
          sendSecond();
        }
        else if (areaDic.third.x <= winMouseX && winMouseX <= areaDic.third.w
        && areaDic.third.y <= winMouseY && winMouseY < areaDic.third.h){
          touchState = 3;
          sendThird();
        }
        else if (areaDic.bottom.x <= winMouseX && winMouseX <= areaDic.bottom.w
        && areaDic.bottom.y <= winMouseY && winMouseY <= areaDic.bottom.h){
          touchState = 4;
          sendBottom();
        }
      }
      function playSynth(){
        // time from now (in seconds)
        var time = 0;
        // note duration (in seconds)
        var dur = 0.05;
        // velocity (volume, from 0 to 1)
        var v = 0.8;
        polySynthA.setADSR(0.002,0,1,0.002);
        polySynthA.play("Eb8", v, time, dur);
      }
      function playSynthB(len) {
        // time from now (in seconds)
        var time = 0;
        // note duration (in seconds)
        var dur = len/3;
        // velocity (volume, from 0 to 1)
        var v = 1;
        polySynth.setADSR(dur,dur,1,0);
        polySynth.play("G2", v, time, dur);
      }
      function playSynthC(len) {
        // time from now (in seconds)
        var time = 0;
        // note duration (in seconds)
        var dur = len/3;
        // velocity (volume, from 0 to 1)
        var v = 0.8;
        polySynthC.setADSR(dur,dur,1,0);
        polySynthC.play("E3", v, time, dur);
      }
      function playSynthD(len) {
        // time from now (in seconds)
        var time = 0;
        // note duration (in seconds)
        var dur = len/3;
        // velocity (volume, from 0 to 1)
        var v = 0.6;
        polySynthD.setADSR(dur,dur,1,0);
        polySynthD.play("C4", v, time, dur);
      }
      function playSynthE(len) {
        // time from now (in seconds)
        var time = 0;
        // note duration (in seconds)
        var dur = len/9;
        // velocity (volume, from 0 to 1)
        var v = 0.8;
        polySynthE.setADSR(dur,dur,1,dur);
        polySynthE.play("Bb3", v, time, dur);
      }
      function playSynthF(len) {
        // time from now (in seconds)
        var time = 0;
        // note duration (in seconds)
        var dur = len/3;
        // velocity (volume, from 0 to 1)
        var v = 1;
        polySynthF.setADSR(dur,dur,1,0);
        polySynthF.play("Bb3", v, time, dur);
      }
      function playSynthG(len) {
        // time from now (in seconds)
        var time = 0;
        // note duration (in seconds)
        var dur = len/3;
        // velocity (volume, from 0 to 1)
        var v = 0.6;
        polySynthG.setADSR(dur,dur,1,0);
        polySynthG.play("B3", v, time, dur);
      }
    </script>

    <!-- socketio -->
    <script>
      var socket = io.connect();

      socket.on("server_to_client", function(data){appendMsg(data)});
      function appendMsg(data) {
        stateArray = data;
      }

      function sendTop(){
        socket.emit("client_to_server", 1);
      }
      function sendSecond(){
        socket.emit("client_to_server", 2);
      }
      function sendThird(){
        socket.emit("client_to_server", 3);
      }
      function sendBottom(){
        socket.emit("client_to_server", 4);
      }
      function sendReset(){
        socket.emit("client_to_server", "reset");
      }
    </script>

  </body>
</html>